<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>永恆之愛 · Temple of Eternal Love</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,300;0,400;0,600;1,400&family=Orbitron:wght@400;700&family=Dancing+Script:wght@500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Philosopher:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Shared Theme Variables */
            --space-black: #02041b;
            --holoscreen-bg: rgba(10, 25, 47, 0.85);
            --glow-cyan: #64ffda; /* Keeping some for generic glows */
            --glow-magenta: #f779dd; /* Keeping some for generic glows */
            --text-primary: #e6f1ff;
            --text-secondary: #8892b0;
            --highlight-glass: rgba(4, 24, 61, 0.6);
            --border-glass: rgba(100, 255, 218, 0.1); /* Still for subtle borders */
            --font-body: 'Philosopher', serif;
            --font-display: 'Cinzel Decorative', serif;
            --font-handwriting: 'Dancing Script', cursive;
            --font-chinese: 'Noto Serif SC', serif;
            --transition-fast: all 0.25s cubic-bezier(0.645, 0.045, 0.355, 1);
            
            /* Game-specific Palette (Ancient Mystical Sanctuary) */
            --gold: #ffd700; 
            --gold-light: #fff3c4;
            --deep-purple: #4a0e4e; 
            --crimson: #dc143c; 
            --jade: #00a86b;
            --soft-violet: #8a2be2;
            --shadow-color: rgba(0, 0, 0, 0.7);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: var(--font-body); 
            background-color: var(--space-black);
            min-height: 100vh; 
            overflow-x: hidden; 
            color: var(--text-primary); 
        }
        
        /* --- BACKGROUND & AMBIENT EFFECTS (from styles.css) --- */
        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(ellipse at 50% 50%, #1a2a45 0%, #0d152b 50%, #02041b 100%); }
        .stars-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); opacity: 0.5; }
        .chinese-pattern {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect x="0" y="0" width="100" height="100" fill="none"/><path d="M 50 0 L 100 50 L 50 100 L 0 50 Z" fill="none" stroke="%23ffd70020" stroke-width="1"/><path d="M 25 0 L 50 25 L 25 50 L 0 25 Z" fill="none" stroke="%23ffd70010" stroke-width="0.5"/><path d="M 75 0 L 100 25 L 75 50 L 50 25 Z" fill="none" stroke="%23ffd70010" stroke-width="0.5"/><path d="M 25 50 L 50 75 L 25 100 L 0 75 Z" fill="none" stroke="%23ffd70010" stroke-width="0.5"/><path d="M 75 50 L 100 75 L 75 100 L 50 75 Z" fill="none" stroke="%23ffd70010" stroke-width="0.5"/></svg>');
            opacity: 0.1;
            pointer-events: none;
            display: block;
        }
        #particles-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0.8; }
        
        /* --- ASTEROID BUTTON (from styles.css) --- */
        @keyframes drift { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(2px, 4px) rotate(-1deg); } 50% { transform: translate(-2px, -2px) rotate(1deg); } 75% { transform: translate(3px, -3px) rotate(-0.5deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        #back-to-menu-asteroid {
            position: fixed; top: 30px; left: 30px; width: 80px; height: 80px;
            background: var(--deep-purple); border: 1px solid var(--gold);
            color: var(--gold-light); font-family: var(--font-display); font-size: 1rem;
            text-decoration: none;
            cursor: pointer; z-index: 1000; border-radius: 50%;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5), 3px 3px 10px rgba(0,0,0,0.4), 0 0 20px var(--soft-violet);
            transition: var(--transition-fast);
            animation: drift 15s ease-in-out infinite;
            display: flex; align-items: center; justify-content: center;
        }
        #back-to-menu-asteroid:hover { transform: scale(1.05); box-shadow: inset 0 0 15px rgba(0,0,0,0.5), 3px 3px 10px rgba(0,0,0,0.4), 0 0 30px var(--gold), 0 0 40px var(--soft-violet); animation-play-state: paused; }
       
        /* --- LAYOUT & STRUCTURE --- */
        .container { position: relative; z-index: 10; max-width: 1400px; margin: 0 auto; padding: 40px 20px; color: var(--gold-light); }
        .header { text-align: center; margin-bottom: 60px; animation: fade-in 2s ease-out; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        .main-title { font-family: var(--font-chinese); font-size: clamp(2.5em, 6vw, 4em); color: var(--gold); text-shadow: 0 0 15px var(--gold); letter-spacing: 5px; margin-bottom: 20px; }
        .subtitle { font-family: var(--font-body); font-size: clamp(1.2em, 3vw, 1.5em); font-style: italic; color: var(--text-secondary); }
        .divider { width: 300px; height: 2px; margin: 40px auto; background: linear-gradient(90deg, transparent, var(--gold), transparent); box-shadow: 0 0 15px var(--gold); }
        .section-title { text-align: center; font-family: var(--font-display); font-size: 2.5em; color: var(--gold); margin: 20px 0 40px 0; text-shadow: 0 0 10px var(--gold), 0 0 15px var(--soft-violet); }
        .games-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 40px; }
        .games-grid-duo { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); max-width: 900px; margin: 0 auto; }

        /* --- NEW HALL CARDS --- */
        .halls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 50px;
            padding: 20px 0;
            max-width: 1200px;
            margin: 40px auto;
        }
        .hall-card {
            position: relative;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 4px solid rgba(255, 215, 0, 0.5);
            box-shadow: 0 10px 40px var(--shadow-color), inset 0 0 30px var(--deep-purple);
            transition: transform 0.4s ease, box-shadow 0.4s ease, border-color 0.4s ease;
        }
        .hall-card:hover {
            transform: scale(1.05);
            border-color: var(--gold);
            box-shadow: 0 20px 60px var(--shadow-color), 0 0 50px var(--soft-violet), inset 0 0 40px var(--deep-purple);
        }
        .hall-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }
        .hall-card:hover img { transform: scale(1.1); }
        .hall-overlay {
            position: absolute;
            inset: 0;
            background: rgba(26, 10, 62, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            transition: background-color 0.4s ease;
        }
        .hall-card:hover .hall-overlay { background: rgba(26, 10, 62, 0.4); }
        .hall-overlay h2 {
            font-family: var(--font-display);
            font-size: clamp(1.5em, 4vw, 2.2em);
            color: var(--gold-light);
            text-shadow: 0 0 15px var(--shadow-color), 0 0 20px var(--soft-violet);
        }
        #games-view { animation: fade-in 1s ease-out; }
        .back-button {
            display: block;
            margin: 0 auto 40px auto;
        }
        .games-section { display: none; }

        /* --- CARD STYLING --- */
        .game-card { display: flex; flex-direction: column; background: linear-gradient(135deg, var(--deep-purple), #110c1f); border-radius: 20px; padding: 30px; border: 2px solid rgba(255,215,0,0.3); box-shadow: 0 10px 30px var(--shadow-color), inset 0 0 20px rgba(74,14,78,0.5); transition: transform 0.4s ease, box-shadow 0.4s ease, border-color 0.4s ease; }
        .game-card:hover { transform: translateY(-10px); border-color: rgba(255,215,0,0.8); box-shadow: 0 20px 50px var(--shadow-color), 0 0 40px rgba(138,43,226,0.5); }
        .game-card-header { flex-grow: 1; }
        .card-icon { font-size: 3em; margin-bottom: 20px; display: block; text-shadow: 0 0 20px var(--gold); color: var(--gold); }
        .game-card h2 { font-family: var(--font-chinese); font-size: 2em; color: var(--gold); margin-bottom: 15px; }
        .game-card p { font-size: 1.1em; line-height: 1.8; color: var(--gold-light); margin-bottom: 30px; }

        /* --- BUTTONS & INTERACTIVE ELEMENTS --- */
        .action-button { background: linear-gradient(135deg, var(--deep-purple), var(--crimson)); color: var(--gold-light); border: 2px solid rgba(255,215,0,0.5); padding: 15px 35px; border-radius: 30px; font-size: 1.1em; font-family: var(--font-display); letter-spacing: 2px; cursor: pointer; transition: all 0.4s ease; box-shadow: 0 5px 15px var(--shadow-color); margin-top: auto; }
        .action-button:hover { transform: translateY(-5px); border-color: var(--gold); box-shadow: 0 10px 25px var(--shadow-color), 0 0 20px var(--crimson); }
        .game-content { display: none; }
        @keyframes content-reveal { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        input, textarea, select { width: 100%; padding: 15px; margin: 10px 0 20px 0; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,215,0,0.4); border-radius: 10px; color: var(--gold-light); font-size: 1.1em; font-family: var(--font-body); }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 15px rgba(255,215,0,0.5); }
        .score-display, .result-display { font-family: var(--font-display); text-align: center; margin: 20px 0; padding: 15px; border-radius: 10px; }
        .score-display { font-size: 1.8em; color: var(--gold); background: rgba(74,14,78,0.3); border: 1px solid rgba(255,215,0,0.3); }
        .result-display { font-size: 1.2em; color: var(--gold-light); background: rgba(74,14,78,0.6);}
        .result-display.success { background: rgba(0,168,107,0.2); color: var(--jade); border: 1px solid var(--jade); }
        .result-display.fail { background: rgba(220,20,60,0.2); color: var(--crimson); border: 1px solid var(--crimson); }
        
        .cosmic-timer { font-family: var(--font-display); font-size: 4em; color: var(--crimson); text-align: center; margin: 20px 0; text-shadow: 0 0 20px var(--crimson); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes timer-drain { from { width: 100%; } to { width: 0%; } }
        .timer-bar-container { width: 100%; height: 8px; background: rgba(74,14,78,0.5); border-radius: 4px; margin: 15px 0; }
        .timer-bar { height: 100%; background: linear-gradient(90deg, var(--crimson), var(--gold)); border-radius: 4px; animation: timer-drain 10s linear; animation-play-state: running; }

        .question-box { background: rgba(74,14,78,0.4); padding: 25px; border-radius: 10px; margin: 20px 0; border-left: 4px solid var(--gold); font-size: 1.2em; font-style: italic; color: var(--gold-light); }
        .choice-btn { display: block; width: 100%; text-align: left; padding: 18px; margin: 10px 0; background: rgba(74,14,78,0.6); border: 2px solid rgba(255,215,0,0.3); color: var(--gold-light); font-size: 1.1em; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .choice-btn:hover:not(:disabled) { background: rgba(138,43,226,0.4); border-color: var(--gold); transform: translateX(10px); color: var(--gold); }
        .choice-btn:disabled { cursor: default; opacity: 0.7; }
        
        /* --- JIGSAW PUZZLE STYLES --- */
        #jigsaw-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 900px; margin: auto; }
        #jigsaw-pieces-container { width: 250px; min-height: 400px; background: rgba(0,0,0,0.6); border: 2px dashed rgba(255,215,0,0.4); border-radius: 10px; padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; align-content: flex-start;}
        #jigsaw-board { display: grid; border: 2px solid var(--gold); box-shadow: 0 0 20px var(--gold), 0 0 30px var(--soft-violet); }
        .jigsaw-piece { cursor: grab; background-size: 400px 400px; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.3);}
        .jigsaw-piece:hover { transform: scale(1.1); box-shadow: 0 0 15px var(--gold); z-index: 10; }
        .jigsaw-slot { 
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,215,0,0.1);
            position: relative; display: flex; align-items: center; justify-content: center;
            font-size: 2em; color: rgba(255, 215, 0, 0.3);
            cursor: pointer; transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }
        .jigsaw-slot:hover { background-color: rgba(255, 215, 0, 0.1); }
        .jigsaw-slot.highlighted { background-color: rgba(255, 215, 0, 0.2); box-shadow: 0 0 15px var(--gold); color: var(--gold); }
        .jigsaw-slot .jigsaw-piece { cursor: default; border: none; }
        .jigsaw-slot .jigsaw-piece:hover { transform: none; box-shadow: none; }
        #jigsaw-controls { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:20px;}
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);}}
        .shake-error { animation: shake 0.3s linear; }
        
        /* --- GAME-SPECIFIC & REWARD MODAL STYLING --- */
        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .memory-card { aspect-ratio: 1; background: linear-gradient(135deg, var(--deep-purple), #110c1f); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: clamp(1.5em, 5vw, 2.5em); color: var(--gold); cursor: pointer; border: 2px solid rgba(255,215,0,0.4); transition: transform 0.6s; transform-style: preserve-3d; }
        .memory-card .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
        .memory-card .back { background: linear-gradient(135deg, var(--deep-purple), var(--crimson)); }
        .memory-card .front { transform: rotateY(180deg); background: rgba(255,215,0,0.2); color: var(--gold); }
        .memory-card.flipped { transform: rotateY(180deg); }
        .memory-card.matched { border-color: var(--jade); box-shadow: 0 0 20px var(--jade); }
        .tarot-card { width: 220px; height: 350px; margin: 20px auto; perspective: 1000px; cursor: pointer; }
        .tarot-inner { width: 100%; height: 100%; position: relative; transition: transform 0.8s; transform-style: preserve-3d; }
        .tarot-card.flipped .tarot-inner { transform: rotateY(180deg); }
        .tarot-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; border: 3px solid var(--gold); display: flex; align-items: center; justify-content: center; text-align: center; }
        .tarot-back { background: linear-gradient(135deg, var(--deep-purple), #111); font-size: 4em; color: var(--gold); }
        .tarot-front { background: #000; transform: rotateY(180deg); flex-direction: column; padding: 20px; color: var(--gold-light); }
        .reward-modal { display: none; position: fixed; z-index: 1000; inset: 0; background: var(--space-black)cc; backdrop-filter: blur(5px); animation: fade-in 0.5s; text-align: center; }
        .reward-modal-content { position: relative; display: inline-block; vertical-align: middle; top: 50%; transform: translateY(-50%); background: #110c1f; padding: 30px; border-radius: 20px; border: 2px solid var(--gold); text-align: center; box-shadow: 0 0 50px var(--soft-violet); width: 90%; max-width: 500px; }
        .reward-modal h2 { font-family: var(--font-display); color: var(--gold); margin-bottom: 20px; text-shadow: 0 0 10px var(--gold); }
        .reward-modal img { max-width: 100%; max-height: 60vh; border-radius: 10px; margin-top: 10px; border: 2px solid var(--gold); }
        .reward-modal p { font-family: var(--font-body); font-size: 1.4em; line-height: 1.6; color: var(--gold-light); }
        .close-button { position: absolute; top: 15px; right: 20px; font-size: 2em; cursor: pointer; color: var(--text-secondary); z-index: 1001; transition: var(--transition-fast); }
        .close-button:hover { color: var(--gold); transform: rotate(90deg); }

        /* --- GAME PLAY MODAL --- */
        .game-play-modal-content {
            position: relative;
            display: inline-block;
            vertical-align: middle;
            top: 50%;
            transform: translateY(-50%);
            background: #110c1f;
            padding: 40px;
            border-radius: 20px;
            border: 2px solid var(--gold);
            text-align: left;
            box-shadow: 0 0 50px var(--soft-violet);
            width: auto;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            transition: max-width 0.4s ease;
        }
        .game-play-modal-content.size-small { max-width: 500px; }
        .game-play-modal-content.size-medium { max-width: 800px; }
        .game-play-modal-content.size-large { max-width: 1100px; }
        
        #game-play-area .game-card-header {
            text-align: center;
            border-bottom: 2px solid rgba(255, 215, 0, 0.5);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        #game-play-area .game-card-header h2 { color: var(--gold); }
        #game-play-area .game-card-header p { color: var(--text-secondary); font-size: 1.1em; max-width: 600px; margin-left: auto; margin-right: auto; }

        #game-play-area .game-content {
            margin-top: 0; padding: 0; border: none;
            background: transparent; box-shadow: none; animation: none;
        }

    </style>
</head>
<body>
    <div class="background-container">
        <div class="stars-bg"></div>
        <div class="chinese-pattern"></div>
        <canvas id="particles-canvas"></canvas>
    </div>

    <a href="index.html" id="back-to-menu-asteroid" title="Back to Menu">
        <span>MENU</span>
    </a>
   
    <div class="container">
        <header class="header">
            <h1 class="main-title">永恆之愛殿堂</h1>
            <p class="subtitle">Temple of Eternal Love</p>
            <div class="divider"></div>
        </header>

        <div id="halls-view">
            <div class="halls-grid">
                <div class="hall-card" onclick="showGamesView('deep-connection')">
                    <img src="photos/Hall of Deep Connection.jpg" alt="Hall of Deep Connection">
                    <div class="hall-overlay"><h2>Hall of Deep Connection</h2></div>
                </div>
                <div class="hall-card" onclick="showGamesView('interplay')">
                    <img src="photos/Sanctuary of Interplay.jpg" alt="Sanctuary of Interplay">
                    <div class="hall-overlay"><h2>Sanctuary of Interplay</h2></div>
                </div>
                <div class="hall-card" onclick="showGamesView('shared-history')">
                    <img src="photos/hall of Shared History.jpg" alt="Gallery of Shared History">
                    <div class="hall-overlay"><h2>Hall of Shared History</h2></div>
                </div>
            </div>
        </div>

        <div id="games-view" style="display: none;">
            <button class="action-button back-button" onclick="showHallsView()">← Back to Halls</button>
            
            <div id="deep-connection-games" class="games-section">
                <h2 class="section-title">Hall of Deep Connection</h2>
                <main class="games-grid">
                    <div class="game-card">
                        <div class="game-card-header">
                            <span class="card-icon">🔮</span>
                            <h2>灵魂共鸣<br>Soul Resonance</h2>
                            <p>Answer questions from your shared history to test your cosmic alignment.</p>
                        </div>
                        <button class="action-button" onclick="startGame('soul-quiz', this)">Begin Resonance</button>
                        <div id="soul-quiz-content" class="game-content">
                            <div id="soul-question" class="question-box"></div>
                            <div id="soul-options"></div>
                            <div class="score-display">Harmony: <span id="soul-score">0 / 20</span></div>
                        </div>
                    </div>
                    <div class="game-card">
                        <div class="game-card-header">
                            <span class="card-icon">⚡️</span>
                            <h2>爱情能量<br>Lightning Round</h2>
                            <p>A rapid-fire quiz with a 10-second timer per question. Three mistakes and the storm ends!</p>
                        </div>
                        <button class="action-button" onclick="startGame('love-meter', this)">Summon Storm</button>
                        <div id="love-meter-content" class="game-content">
                            <div id="love-meter-stats" style="display: flex; justify-content: space-around; font-size: 1.2em;">
                                <div>Score: <span id="love-score">0</span></div>
                                <div>Lives: <span id="love-lives">❤️❤️❤️</span></div>
                            </div>
                            <div class="timer-bar-container"><div id="love-timer-bar" class="timer-bar"></div></div>
                            <div id="love-question" class="question-box"></div>
                            <div id="love-options"></div>
                        </div>
                    </div>
                    <div class="game-card">
                        <div class="game-card-header">
                            <span class="card-icon">🌸</span>
                            <h2>天界记忆<br>Celestial Memory Nexus</h2>
                            <p>Match the sacred symbols of your journey hidden among the stars.</p>
                        </div>
                        <button class="action-button" onclick="startGame('memory', this)">Enter the Nexus</button>
                        <div id="memory-content" class="game-content">
                            <div class="score-display">Moves: <span id="memory-moves">0</span> | Matches: <span id="memory-matches">0/8</span></div>
                            <div id="memory-grid" class="memory-grid"></div>
                        </div>
                    </div>
                     <div class="game-card">
                        <div class="game-card-header">
                            <span class="card-icon">🎭</span>
                            <h2>真假回忆<br>Two Truths, One Lie</h2>
                            <p>Three statements about your story are presented. Two are true, one is false. Can you spot the lie?</p>
                        </div>
                        <button class="action-button" onclick="startGame('two-truths', this)">Begin Deception</button>
                        <div id="two-truths-content" class="game-content">
                            <div id="two-truths-options"></div>
                            <div id="two-truths-feedback" class="result-display" style="display:none; margin-top:20px;"></div>
                            <button class="action-button" onclick="initTwoTruths()" style="display:none; margin: 20px auto 0;">Next Round</button>
                        </div>
                    </div>
                </main>
            </div>
            
            <div id="interplay-games" class="games-section">
                <h2 class="section-title">Sanctuary of Interplay</h2>
                <main class="games-grid">
                     <div class="game-card">
                        <div class="game-card-header">
                            <span class="card-icon">💬</span>
                            <h2>心有灵犀<br>Echoes of the Heart</h2>
                            <p>Can you tell who's speaking? Guess if the quote belongs to Nic or Zoya. You have two tries!</p>
                        </div>
                        <button class="action-button" onclick="startGame('echoes-quiz', this)">Hear the Echoes</button>
                        <div id="echoes-quiz-content" class="game-content">
                            <div id="echoes-quiz-question" class="question-box"></div>
                            <div id="echoes-quiz-options"></div>
                            <div id="echoes-quiz-feedback" class="result-display" style="display: none; margin-top: 20px;"></div>
                        </div>
                    </div>
                    <div class="game-card">
                        <div class="game-card-header">
                            <span class="card-icon">🧩</span>
                            <h2>星辰拼图<br>Celestial Jigsaw</h2>
                            <p>A cherished memory has been shattered! Piece it back together against the clock.</p>
                        </div>
                        <button class="action-button" onclick="startGame('jigsaw', this)">Rebuild Memory</button>
                        <div id="jigsaw-content" class="game-content">
                            <div id="jigsaw-controls">
                                <button class="action-button" onclick="showJigsawPreview()">Preview</button>
                                <button class="action-button" onclick="retryJigsaw()">Retry</button>
                                <button class="action-button" onclick="newJigsaw()">New Picture</button>
                            </div>
                            <div class="score-display">Time: <span id="jigsaw-timer">0s</span> | Lives: <span id="jigsaw-lives">❤️❤️❤️</span></div>
                            <div id="jigsaw-container">
                                <div id="jigsaw-pieces-container"></div>
                                <div id="jigsaw-board"></div>
                            </div>
                        </div>
                    </div>
                    <div class="game-card">
                        <div class="game-card-header">
                            <span class="card-icon">🃏</span>
                            <h2>灵魂塔罗<br>Tarot of Souls</h2>
                            <p>Draw from the deck of destiny. Will you face a deep truth, a daring challenge, or a prophecy?</p>
                        </div>
                        <button class="action-button" onclick="startGame('tarot', this)">Consult Oracle</button>
                        <div id="tarot-content" class="game-content">
                            <select id="tarot-choice" style="margin-bottom: 20px;">
                                <option value="truth">Truth - 揭示真相</option>
                                <option value="dare">Dare - 接受挑战</option>
                                <option value="prophecy">Prophecy - 预言未来</option>
                            </select>
                            <div class="tarot-card" id="tarot-card" onclick="this.classList.toggle('flipped')">
                                <div class="tarot-inner">
                                    <div class="tarot-face tarot-back">✨</div>
                                    <div class="tarot-face tarot-front">
                                        <div id="tarot-result-icon" style="font-size: 2em; margin-bottom: 10px;"></div>
                                        <div id="tarot-result-text" style="font-size: 0.9em;"></div>
                                    </div>
                                </div>
                            </div>
                            <button class="action-button" onclick="drawTarot()" style="margin-top: 20px;">Draw New Card</button>
                        </div>
                    </div>
                    <div class="game-card">
                        <div class="game-card-header">
                            <span class="card-icon">🥠</span>
                            <h2>命运之签<br>Fortune Cookie</h2>
                            <p>Break open a cookie from the cosmos. What message does the universe have for you?</p>
                        </div>
                        <button class="action-button" onclick="startGame('fortune', this)">Reveal Fortune</button>
                        <div id="fortune-content" class="game-content">
                            <div id="fortune-text" class="result-display success"></div>
                        </div>
                    </div>
                </main>
            </div>

            <div id="shared-history-games" class="games-section">
                <h2 class="section-title">Hall of Shared History</h2>
                <main class="games-grid" style="max-width: 800px; margin: 0 auto;">
                     <div class="game-card">
                        <div class="game-card-header">
                            <span class="card-icon">📜</span>
                            <h2>过往的回响<br>Echoes of the Past</h2>
                            <p>Relive a moment from your story. The cosmos asks you to remember and reflect on the path you've walked together.</p>
                        </div>
                        <button class="action-button" onclick="startGame('echoes', this)">Hear the Echo</button>
                        <div id="echoes-content" class="game-content">
                            <div id="echo-quote" class="question-box"></div>
                            <p id="echo-question" style="text-align: center; font-size: 1.3em; color: var(--gold);"></p>
                            <button class="action-button" onclick="nextEcho()" style="display: block; margin: 20px auto 0;">Next Echo</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="game-play-modal" class="reward-modal">
        <div class="game-play-modal-content">
            <span class="close-button" onclick="closeGame()">&times;</span>
            <div id="game-play-area"></div>
        </div>
    </div>

    <div id="reward-modal" class="reward-modal">
        <div class="reward-modal-content">
            <span class="close-button" onclick="closeRewardModal()">&times;</span>
            <h2 id="reward-title">A Reward from the Cosmos!</h2>
            <div id="reward-display"></div>
        </div>
    </div>

    <script>
        // --- CONFIG & DATA ---
        let gameContentOriginalParent = null;
        let activeGameId = null;

        function showGamesView(hallId) {
            document.getElementById('halls-view').style.display = 'none';
            document.getElementById('games-view').style.display = 'block';
            document.querySelectorAll('.games-section').forEach(section => {
                section.style.display = 'none'
            });
            document.getElementById(hallId + '-games').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function showHallsView() {
            closeGame(); // Close any open game modal
            document.getElementById('games-view').style.display = 'none';
            document.getElementById('halls-view').style.display = 'block';
            window.scrollTo(0, 0);
        }

        const SOUL_QUIZ=[{q:"Where did your first conversation happen?",o:["Library","Sports Field","Classroom"],a:1},{q:"What subject does Nic love talking about?",o:["Art","History","Mathematics"],a:2},{q:"What was your first meal on a date together?",o:["Sushi","Chicken Steak","Ramen"],a:1},{q:"What item of Zoya's did Nic fix?",o:["Her Phone","Her Laptop","Her Bicycle"],a:2},{q:"A typhoon delayed Nic's flight from which city?",o:["Tokyo","Kyoto","Osaka"],a:1},{q:"What was the first picture Zoya sent Nic?",o:["A selfie","Her fluffy hair","A drawing"],a:1},{q:"Nic stood out in school like which landmark?",o:["Mt. Fuji","Tokyo Tower","Imperial Palace"],a:1},{q:"What did Nic draw in his first art class with Zoya?",o:["A portrait","An elephant","Two people dancing"],a:2},{q:"Who sent the Facebook friend request first?",o:["Nic","Zoya","A friend added both"],a:1},{q:"Nic is from Uganda, which he calls the 'Pearl of ___'?",o:["The Nile","Africa","The Savannah"],a:1},{q:"What was Nic's original course in school?",o:["Automotive","General","Special"],a:0},{q:"Who got lost with Nic while trying to find Zoya's house?",o:["Reynaldo","Zion","Hans"],a:2},{q:"What is Zoya's younger sister's name?",o:["Reneleene","Zoie","Curly"],a:1},{q:"Who first broke the ice in your first conversation?",o:["Nic","Hans","Zoya"],a:2},{q:"At what time did Nic send his first 'Hi Zoya' message?",o:["11:35 p.m.","10:06 p.m.","2:00 a.m."],a:1},{q:"What was Zoya's simple reply to meeting at the library?",o:["'Okay, see you then.'","'Fine, I will go there tomorrow.'","'I'd love to!'"],a:1},{q:"What did Zoya's father enjoy cooking for guests?",o:["Barbecue","Sushi","Chicken Steak"],a:0},{q:"What did Zoya think Nic was sending instead of a text message during the 'misunderstanding'?",o:["A gift","He passed by her home","A letter"],a:1},{q:"What airport did Nic fly from during the typhoon?",o:["Narita","Haneda","Kansai"],a:2},{q:"What color was Zoya's skirt at the English club event?",o:["Blue","White","Pink"],a:1}];
        const LIGHTNING_QUESTIONS=[{q:"Who sent the Facebook friend request first?",o:["Nic","Zoya"],a:1},{q:"What was Nic's original course?",o:["Automotive","Science"],a:0},{q:"What is Zoya's sister's name?",o:["Zoie","Zoe"],a:0},{q:"Who got lost with Nic looking for Zoya's house?",o:["Hans","Zion"],a:0},{q:"What did Zoya's father enjoy cooking?",o:["Barbecue","Curry"],a:0},{q:"What did Nic draw in the first art class?",o:["An elephant","Two people dancing"],a:1},{q:"Who spoke first when you met?",o:["Nic","Zoya"],a:1}];
        const MEMORY_SYMBOLS=['📖','🚲','✈️','🎨','🍗','💌','🎂','🤝'];
        const TAROT={truth:[{i:'💕',t:"The Lovers: Describe the moment you knew your feelings were more than friendship."},{i:'🌟',t:"The Star: What's a hope for your future you've never said out loud?"},{i:'☀️',t:"The Sun: What is your single happiest memory of just the two of you?"},{i:'🌙',t:"The Moon: What is a secret fear you have about the future that your partner can help soothe?"}],dare:[{i:'🎩',t:"The Magician: Create a 'magic spell' using only three words that describes your love."},{i:'🃏',t:"The Fool: Take a leap of faith: tell your partner a silly, secret dream you have."},{i:'📜',t:"The Hierophant: Create a new tradition (e.g., a special handshake) and perform it now."},{i:'⚔️',t:"The Chariot: Plan your next 'adventure' date, even if it's just a walk to a new place."}],prophecy:[{i:'🔮',t:"The World: Many more journeys await you, hand in hand, across different corners of the world."},{i:'✨',t:"The Empress: A future of shared creativity and building a beautiful home together is foreseen."},{i:'🦁',t:"Strength: You will continue to give each other the courage to overcome any obstacle life presents."}]};
        const ECHOES_QUIZ=[{q:"'I just needed someone who could understand me.'",a:"Nic"},{q:"'He possessed an aura of mysterious allure, tall and lanky...'",a:"Zoya"},{q:"'I never thought in my life I would ever meet a girl who listened to me talk about mathematics.'",a:"Nic"},{q:"'I was supposed to enter a Chinese-basis school where I can learn Japanese...'",a:"Zoya"},{q:"'If I send her a friend request and she accepts it, then what happens next?'",a:"Nic"}];
        const ECHOES=[{quote:"'My name is Zhang Zoya,' she said, breaking the ice. 'I'm Nicholas Lubega, and I love mathematics,' I talked back.",question:"Do you remember the feeling of that first conversation?"},{quote:"A typhoon happened in Kyoto that made all the flights of that day be cancelled. I wanted to rush home.",question:"What would have happened if the flight wasn't rebooked?"},{quote:"'And if it's possible, take some photos in Kyoto, I'd like to see where you will be.' ... In exchange without me asking, she sent her own picture showing her fluffy hair.",question:"How did this small exchange change your connection?"}];
        const TWO_TRUTHS_SETS=[{t1:"Nic's first school course was Automotive.",t2:"The first meal you shared on a date was Chicken Steak.",lie:"Nic sent the first Facebook friend request.",ans:2},{t1:"Zoya's little sister's name is Zoie.",t2:"Nic flew through a typhoon to get to an event Zoya was at.",lie:"The friend who got lost with Nic was named Zion.",ans:2},{t1:"Nic drew two people dancing in his first art class.",t2:"Zoya wore a long white skirt at the English club event.",lie:"You confessed your love for each other at the library.",ans:2}];
        const JIGSAW_IMAGES = Array.from({length: 20}, (_, i) => `photos/photo${i + 1}.jpg`);
        const FORTUNES=["A broken bicycle leads to an unbreakable bond.","The one who listens to you talk about math is your destiny.","Even a typhoon cannot stop two destined souls.","Your future is as bright as her eyes.","A cheesy goodnight poem becomes a treasured memory.","Like a chicken steak at Joyful, your love is a perfect and reliable choice.","A shared drawing class can illustrate a beautiful future."];
        const REWARDS=Array.from({length:10},(_,i)=>({type:'photo',value:`photos/photo${i+1}.jpg`})).concat([{type:'treat',value:'Nic owes Zoya her favorite bubble tea.'},{type:'treat',value:'Zoya has to give Nic a 10-minute shoulder massage.'},{type:'money',value:'Nic owes Zoya ¥1000 for a shopping spree!'},{type:'money',value:'Zoya owes Nic ¥500 for video games.'}]);
        
        function startGame(id, btnElement) {
            if (activeGameId === id) return;
            if (activeGameId !== null) closeGame();

            const modalContentWrapper = document.querySelector('#game-play-modal .game-play-modal-content');
            modalContentWrapper.className = 'game-play-modal-content'; // Reset classes

            // Add game-specific size class
            if (id === 'jigsaw') {
                modalContentWrapper.classList.add('size-large');
            } else if (['soul-quiz', 'love-meter', 'memory', 'two-truths', 'echoes-quiz'].includes(id)) {
                modalContentWrapper.classList.add('size-medium');
            } else {
                modalContentWrapper.classList.add('size-small');
            }

            const card = btnElement.closest('.game-card');
            const header = card.querySelector('.game-card-header');
            const gameContent = document.getElementById(`${id}-content`);

            if (!gameContent || !card || !header) {
                console.error("Game assets not found for ID:", id);
                return;
            }

            gameContentOriginalParent = gameContent.parentNode;
            const gameArea = document.getElementById('game-play-area');
            
            gameArea.appendChild(header.cloneNode(true));
            gameArea.appendChild(gameContent);

            gameContent.style.display = 'block';
            document.getElementById('game-play-modal').style.display = 'block';
            activeGameId = id;

            // init game logic
            if (id === 'soul-quiz') initSoulQuiz();
            if (id === 'love-meter') startLoveMeter();
            if (id === 'memory') initMemory();
            if (id === 'tarot') drawTarot();
            if (id === 'echoes-quiz') initEchoesQuiz();
            if (id === 'fortune') newFortune();
            if (id === 'echoes') initEchoes();
            if (id === 'two-truths') initTwoTruths();
            if (id === 'jigsaw') initJigsaw();
        }

        function closeGame() {
            const modal = document.getElementById('game-play-modal');
            const gameArea = document.getElementById('game-play-area');
            const gameContent = gameArea ? gameArea.querySelector('.game-content') : null;

            if (gameContent && gameContentOriginalParent) {
                gameContent.style.display = 'none';
                gameContentOriginalParent.appendChild(gameContent);
            }

            if (gameArea) gameArea.innerHTML = '';
            gameContentOriginalParent = null;
            if (modal) modal.style.display = 'none';
            activeGameId = null;
        }

        function triggerReward(title="A Reward from the Cosmos!"){document.getElementById('reward-title').textContent=title;const r=REWARDS[Math.floor(Math.random()*REWARDS.length)];const d=document.getElementById('reward-display');if(r.type==='photo')d.innerHTML=`<img src="${r.value}" alt="A cherished memory" onerror="this.alt='Photo not found'; this.src='https://placehold.co/400x300/000/fff?text=Photo+${r.value.split('/').pop()}';">`;else d.innerHTML=`<p>${r.value}</p>`;document.getElementById('reward-modal').style.display='block'}
        function closeRewardModal(){document.getElementById('reward-modal').style.display='none'}
        
        let sQNum,sScore;function initSoulQuiz(){sQNum=0;sScore=0;document.getElementById('soul-score').textContent=`0 / ${SOUL_QUIZ.length}`;displaySoulQuestion()}
        function displaySoulQuestion(){if(sQNum>=SOUL_QUIZ.length){let resultText="Resonance test complete!<br><br>";if(sScore>=15){resultText+="A perfect cosmic resonance! Your souls are deeply intertwined.";triggerReward()}else if(sScore>=10){resultText+="A strong connection! Your shared memories shine brightly."}else{resultText+="Our memories are a bit hazy... a perfect excuse to create new ones!"}document.getElementById('soul-question').innerHTML=resultText;document.getElementById('soul-options').innerHTML=``;return}const q=SOUL_QUIZ[sQNum];document.getElementById('soul-question').innerHTML=q.q;document.getElementById('soul-options').innerHTML=q.o.map((o,i)=>`<button class="choice-btn" onclick="checkSoulAnswer(${i})">${o}</button>`).join('')}
        function checkSoulAnswer(selectedIndex){const qData=SOUL_QUIZ[sQNum];const options=document.querySelectorAll('#soul-options .choice-btn');options.forEach(btn=>btn.disabled=true);if(selectedIndex===qData.a){sScore++;options[selectedIndex].style.background='var(--jade)'}else{options[selectedIndex].style.background='var(--crimson)';options[qData.a].style.background='var(--jade)'}sQNum++;updateSoulScore();setTimeout(()=>displaySoulQuestion(),1500)}
        function updateSoulScore(){document.getElementById('soul-score').textContent=`${sScore} / ${SOUL_QUIZ.length}`}
        
        let lTimer,lLives,lScore,lCurrentQ,lQuestions;function startLoveMeter(){lLives=3;lScore=0;lQuestions=[...LIGHTNING_QUESTIONS].sort(()=>.5-Math.random()).map(q=>({...q,answered:!1}));document.getElementById('love-lives').textContent='❤️❤️❤️';document.getElementById('love-score').textContent='0';nextLoveQuestion()}
        function nextLoveQuestion(){if(lCurrentQ)lCurrentQ.answered=!0;lCurrentQ=lQuestions.find(q=>!q.answered);if(!lCurrentQ||lLives<=0){clearInterval(lTimer);document.getElementById('love-question').innerHTML=`The storm has passed! Final Score: ${lScore}`;document.getElementById('love-options').innerHTML='';if(lScore>=5)triggerReward();return}const timerBar=document.getElementById('love-timer-bar');timerBar.style.animation='none';void timerBar.offsetWidth;timerBar.style.animation='timer-drain 10s linear';document.getElementById('love-question').innerHTML=lCurrentQ.q;document.getElementById('love-options').innerHTML=lCurrentQ.o.map((o,i)=>`<button class="choice-btn" onclick="checkLoveAnswer(${i})">${o}</button>`).join('');lTimer=setTimeout(()=>handleLoveAnswer(!1),10000)}
        function handleLoveAnswer(isCorrect){clearInterval(lTimer);if(isCorrect){lScore++;document.getElementById('love-score').textContent=lScore}else{lLives--;document.getElementById('love-lives').textContent='❤️'.repeat(lLives)+'🤍'.repeat(3-lLives)}document.querySelectorAll('#love-options .choice-btn').forEach(btn=>btn.disabled=!0);setTimeout(()=>nextLoveQuestion(),1200)}
        function checkLoveAnswer(selectedIndex){const correct=selectedIndex===lCurrentQ.a;if(correct){document.querySelectorAll('#love-options .choice-btn')[selectedIndex].style.background='var(--jade)'}else{document.querySelectorAll('#love-options .choice-btn')[selectedIndex].style.background='var(--crimson)'}handleLoveAnswer(correct)}

        let mFlipped,mLock,mMoves,mMatches;function initMemory(){mFlipped=[];mLock=!1;mMoves=0;mMatches=0;updateMemoryScore();const g=document.getElementById('memory-grid');g.innerHTML='';[...MEMORY_SYMBOLS,...MEMORY_SYMBOLS].sort(()=>.5-Math.random()).forEach(s=>{const c=document.createElement('div');c.className='memory-card';c.dataset.symbol=s;c.innerHTML=`<div class="face back">?</div><div class="face front">${s}</div>`;c.addEventListener('click',()=>flipMemoryCard(c));g.appendChild(c)})}
        function flipMemoryCard(c){if(mLock||c.classList.contains('flipped'))return;c.classList.add('flipped');mFlipped.push(c);if(mFlipped.length===2){mLock=!0;mMoves++;if(mFlipped[0].dataset.symbol===mFlipped[1].dataset.symbol){mMatches++;mFlipped.forEach(c=>c.classList.add('matched'));mFlipped=[];mLock=!1;if(mMatches===MEMORY_SYMBOLS.length){let resultText="Nexus Cleared! ";if(mMoves<=12){resultText+="A true cosmic memory master!"}else if(mMoves<=18){resultText+="Stellar recall! Our memories are strong."}else{resultText+="Lost among the stars, but we found our way back together!"}document.querySelector('#memory-content .score-display').innerHTML=`Moves: ${mMoves} | Matches: 8/8 <br><span style='font-size: 0.7em;color:var(--gold)'>${resultText}</span>`;triggerReward()}}else{setTimeout(()=>{mFlipped.forEach(c=>c.classList.remove('flipped'));mFlipped=[];mLock=!1},1200)}updateMemoryScore()}}
        function updateMemoryScore(){if(mMatches<MEMORY_SYMBOLS.length)document.getElementById('memory-moves').textContent=mMoves;document.getElementById('memory-matches').textContent=`${mMatches}/8`}
        
        function drawTarot(){const cardElement=document.getElementById('tarot-card');if(cardElement.classList.contains('flipped')){cardElement.classList.remove('flipped')}setTimeout(()=>{const choice=document.getElementById('tarot-choice').value;const deck=TAROT[choice];const cardData=deck[Math.floor(Math.random()*deck.length)];document.getElementById('tarot-result-icon').textContent=cardData.i;document.getElementById('tarot-result-text').innerHTML=cardData.t},400)}
        
        let eQNum,eTries;function initEchoesQuiz(){eQNum=0;displayEchoesQuestion()}
        function displayEchoesQuestion(){eTries=2;const feedbackEl=document.getElementById('echoes-quiz-feedback');feedbackEl.style.display='none';if(eQNum>=ECHOES_QUIZ.length){document.getElementById('echoes-quiz-question').textContent="You know our hearts well!";document.getElementById('echoes-quiz-options').innerHTML="";triggerReward();return}const q=ECHOES_QUIZ[eQNum];document.getElementById('echoes-quiz-question').innerHTML=`"${q.q}"`;document.getElementById('echoes-quiz-options').innerHTML=`<button class="choice-btn" onclick="checkEchoesAnswer('Nic')">Nic</button><button class="choice-btn" onclick="checkEchoesAnswer('Zoya')">Zoya</button>`}
        function checkEchoesAnswer(choice){const feedbackEl=document.getElementById('echoes-quiz-feedback');const qData=ECHOES_QUIZ[eQNum];if(choice===qData.a){feedbackEl.textContent="Correct! You heard the echo truly.";feedbackEl.className='result-display success';feedbackEl.style.display='block';document.querySelectorAll('#echoes-quiz-options .choice-btn').forEach(btn=>btn.disabled=!0);eQNum++;setTimeout(()=>displayEchoesQuestion(),1500)}else{eTries--;if(eTries>0){feedbackEl.textContent=`Not quite. ${eTries} try remaining.`;feedbackEl.className='result-display fail';feedbackEl.style.display='block'}else{feedbackEl.textContent=`That was from ${qData.a}'s heart. Moving on...`;feedbackEl.className='result-display';feedbackEl.style.display='block';document.querySelectorAll('#echoes-quiz-options .choice-btn').forEach(btn=>btn.disabled=!0);eQNum++;setTimeout(()=>displayEchoesQuestion(),2500)}}}

        function initEchoes(){nextEcho()}
        function nextEcho(){const echo=ECHOES[Math.floor(Math.random()*ECHOES.length)];document.getElementById('echo-quote').textContent=`"${echo.quote}"`;document.getElementById('echo-question').textContent=echo.question}
        
        function initTwoTruths(){const set=TWO_TRUTHS_SETS[Math.floor(Math.random()*TWO_TRUTHS_SETS.length)];const options=[{text:set.t1,isLie:!1},{text:set.t2,isLie:!1},{text:set.lie,isLie:!0}].sort(()=>.5-Math.random());document.getElementById('two-truths-options').innerHTML=options.map((opt,i)=>`<button class="choice-btn" onclick="checkLie(${opt.isLie}, this)">${opt.text}</button>`).join('');document.getElementById('two-truths-feedback').style.display='none';document.querySelector('#two-truths-content button[onclick="initTwoTruths()"]').style.display='none'}
        function checkLie(isLie,btn){document.querySelectorAll('#two-truths-options .choice-btn').forEach(b=>b.disabled=!0);const feedbackEl=document.getElementById('two-truths-feedback');if(isLie){feedbackEl.textContent="You found the lie! Your memory is sharp.";feedbackEl.className='result-display success';triggerReward()}else{feedbackEl.textContent="That was a truth! The lie is still hiding.";feedbackEl.className='result-display fail';btn.style.background='var(--crimson)'}feedbackEl.style.display='block';document.querySelector('#two-truths-content button[onclick="initTwoTruths()"]').style.display='block'}
        
        let jigsawTimerInterval,jigsawSeconds,jigsawLives,jigsawCurrentImage,jigsawPiecesCount,highlightedSlotIndex=null;
        function checkJigsawMove(pieceElement,slotElement){const pieceIndex=pieceElement.dataset.index;const slotIndex=slotElement.dataset.index;const board=document.getElementById('jigsaw-board');if(pieceIndex==slotIndex){slotElement.innerHTML='';slotElement.appendChild(pieceElement);pieceElement.draggable=false;pieceElement.style.cursor='default';if(board.querySelectorAll('.jigsaw-piece').length===jigsawPiecesCount){clearInterval(jigsawTimerInterval);triggerReward(`Puzzle Solved in ${jigsawSeconds}s!`)}}else{jigsawLives--;updateJigsawLives();board.classList.add('shake-error');setTimeout(()=>board.classList.remove('shake-error'),300);if(jigsawLives<=0){clearInterval(jigsawTimerInterval);alert("Out of lives! The memory fades... Try again.")}}const currentlyHighlighted=document.querySelector('.jigsaw-slot.highlighted');if(currentlyHighlighted){currentlyHighlighted.classList.remove('highlighted')}highlightedSlotIndex=null}
        function handleSlotClick(slotElement,index){if(slotElement.hasChildNodes()&&slotElement.textContent.trim()==='')return;const currentlyHighlighted=document.querySelector('.jigsaw-slot.highlighted');if(currentlyHighlighted){currentlyHighlighted.classList.remove('highlighted')}if(highlightedSlotIndex===index){highlightedSlotIndex=null;return}slotElement.classList.add('highlighted');highlightedSlotIndex=index}
        function handlePieceClick(pieceElement){if(pieceElement.parentNode.id!=='jigsaw-pieces-container')return;if(highlightedSlotIndex!==null){const targetSlot=document.querySelector(`.jigsaw-slot[data-index='${highlightedSlotIndex}']`);if(targetSlot){checkJigsawMove(pieceElement,targetSlot)}}}
        function handleJigsawDrop(e){e.preventDefault();const slotElement=e.currentTarget;if(slotElement.hasChildNodes()&&slotElement.textContent.trim()==='')return;const pieceIndex=e.dataTransfer.getData('text');const pieceElement=document.querySelector(`#jigsaw-pieces-container .jigsaw-piece[data-index='${pieceIndex}']`);if(pieceElement){checkJigsawMove(pieceElement,slotElement)}}
        function initJigsaw(newImage=!0){clearInterval(jigsawTimerInterval);highlightedSlotIndex=null;jigsawSeconds=0;jigsawLives=3;let piecesX=4,piecesY=4;const board=document.getElementById('jigsaw-board');if(newImage||!jigsawCurrentImage)jigsawCurrentImage=JIGSAW_IMAGES[Math.floor(Math.random()*JIGSAW_IMAGES.length)];const img=new Image();img.onload=()=>{const boardSize=Math.min(400,window.innerWidth-300);const pieceWidth=boardSize/piecesX;const pieceHeight=boardSize/piecesY;jigsawPiecesCount=piecesX*piecesY;board.innerHTML='';document.getElementById('jigsaw-pieces-container').innerHTML='';board.style.width=`${boardSize}px`;board.style.height=`${boardSize}px`;board.style.gridTemplateColumns=`repeat(${piecesX},1fr)`;let pieces=[];for(let i=0;i<jigsawPiecesCount;i++){const row=Math.floor(i/piecesX),col=i%piecesX;const piece=document.createElement('div');piece.className='jigsaw-piece';piece.draggable=true;piece.dataset.index=i;piece.style.width=`${pieceWidth}px`;piece.style.height=`${pieceHeight}px`;piece.style.backgroundImage=`url(${jigsawCurrentImage})`;piece.style.backgroundSize=`${boardSize}px ${boardSize}px`;piece.style.backgroundPosition=`-${col*pieceWidth}px -${row*pieceHeight}px`;piece.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',i));piece.addEventListener('click',()=>handlePieceClick(piece));pieces.push(piece);const slot=document.createElement('div');slot.className='jigsaw-slot';slot.dataset.index=i;slot.textContent=i+1;slot.addEventListener('dragover',e=>e.preventDefault());slot.addEventListener('drop',handleJigsawDrop);slot.addEventListener('click',()=>handleSlotClick(slot,i));board.appendChild(slot)}pieces.sort(()=>.5-Math.random()).forEach(p=>document.getElementById('jigsaw-pieces-container').appendChild(p));startJigsawTimer();updateJigsawLives()};img.src=jigsawCurrentImage}
        function startJigsawTimer(){jigsawTimerInterval=setInterval(()=>{jigsawSeconds++;document.getElementById('jigsaw-timer').textContent=`${jigsawSeconds}s`},1000)}
        function updateJigsawLives(){document.getElementById('jigsaw-lives').textContent='❤️'.repeat(jigsawLives)+'🤍'.repeat(3-jigsawLives)}
        function retryJigsaw(){initJigsaw(!1)}function newJigsaw(){initJigsaw(!0)}
        function showJigsawPreview(){document.getElementById('reward-title').textContent="Memory Preview";document.getElementById('reward-display').innerHTML=`<img src="${jigsawCurrentImage}" alt="Jigsaw Preview">`;document.getElementById('reward-modal').style.display='block'}

        function newFortune(){document.getElementById('fortune-text').textContent=FORTUNES[Math.floor(Math.random()*FORTUNES.length)];triggerReward()}
    </script>
    <script>
        // --- BACKGROUND MUSIC SCRIPT ---
        let bgMusicPlayer = null;
        let songsData = [];
        let currentMusicState = {};

        function saveGameState() {
            if (bgMusicPlayer && songsData.length > 0) {
                currentMusicState.currentTime = bgMusicPlayer.currentTime;
                currentMusicState.isPlaying = !bgMusicPlayer.paused;
                sessionStorage.setItem('musicPlayerState', JSON.stringify(currentMusicState));
            }
        }
        
        function playNextSong() {
            if (currentMusicState.isShuffled) {
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * songsData.length);
                } while (newIndex === currentMusicState.currentIndex && songsData.length > 1);
                currentMusicState.currentIndex = newIndex;
            } else {
                currentMusicState.currentIndex = (currentMusicState.currentIndex + 1) % songsData.length;
            }
            
            const nextSong = songsData[currentMusicState.currentIndex];
            if (nextSong) {
                bgMusicPlayer.src = nextSong.src;
                bgMusicPlayer.play();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedStateJSON = sessionStorage.getItem('musicPlayerState');
            const songsDataJSON = sessionStorage.getItem('songsData');

            if (savedStateJSON && songsDataJSON) {
                currentMusicState = JSON.parse(savedStateJSON);
                songsData = JSON.parse(songsDataJSON);
                
                const currentSong = songsData[currentMusicState.currentIndex];

                if (currentSong) {
                    bgMusicPlayer = new Audio(currentSong.src);
                    bgMusicPlayer.volume = currentMusicState.volume;
                    
                    bgMusicPlayer.addEventListener('loadedmetadata', () => {
                        bgMusicPlayer.currentTime = currentMusicState.currentTime;
                        if (currentMusicState.isPlaying) {
                            bgMusicPlayer.play().catch(e => console.error("BG music autoplay was prevented."));
                        }
                    }, { once: true });
                    
                    bgMusicPlayer.addEventListener('ended', playNextSong);

                    window.addEventListener('beforeunload', saveGameState);
                }
            }
        });

        // Particle animation script
        const canvas=document.getElementById('particles-canvas'),ctx=canvas.getContext('2d');canvas.width=window.innerWidth;canvas.height=window.innerHeight;const particles=[],particleCount=150;class Particle{constructor(){this.x=Math.random()*canvas.width;this.y=Math.random()*canvas.height;this.size=Math.random()*2+.5;this.speedX=Math.random()*.5-.25;this.speedY=Math.random()*.5-.25;this.opacity=Math.random()*.5+.2;this.color = `rgba(255, 215, 0, ${this.opacity})`;}update(){this.x+=this.speedX;this.y+=this.speedY;if(this.x>canvas.width||this.x<0)this.speedX*=-1;if(this.y>canvas.height||this.y<0)this.speedY*=-1}draw(){ctx.fillStyle=this.color;ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill()}}for(let i=0;i<particleCount;i++){particles.push(new Particle())}function animateParticles(){ctx.clearRect(0,0,canvas.width,canvas.height);particles.forEach(particle=>{particle.update();particle.draw()});requestAnimationFrame(animateParticles)}animateParticles();window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight});
    </script>
</body>
</html>