<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nini & Zoya - The Celestial Sanctuary</title>
    
    <link rel="icon" type="image/png" href="photos/favicon1.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,300;0,400;0,600;1,400&family=Orbitron:wght@400;700&family=Dancing+Script:wght@500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Philosopher:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Cinzel&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@500&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    
    <!-- 
      Blocking script to prevent Flash of Unstyled Content (FOUC).
      This script reads the saved theme from localStorage and applies the
      core background color and theme variables before the page renders.
    -->
    <script>
      (function() {
        const THEMES = {
          mystical: { bodyBg: '#02041b', colors: { '--space-black': '#02041b', '--deep-purple': '#4a0e4e', '--gold': '#ffd700', '--gold-light': '#fff3c4', '--soft-violet': '#8a2be2', '--crimson': '#dc143c', '--jade': '#00a86b', '--text-primary': '#e6f1ff', '--text-secondary': '#8892b0', '--holoscreen-bg': 'rgba(10, 25, 47, 0.85)', '--highlight-glass': 'rgba(4, 24, 61, 0.6)', '--border-glass': 'rgba(100, 255, 218, 0.1)', '--glow-cyan': '#64ffda', '--glow-magenta': '#f779dd', '--shadow-color': 'rgba(0, 0, 0, 0.7)' } },
          ethereal: { bodyBg: '#0a1628', colors: { '--space-black': '#0a1628', '--deep-purple': '#0a2540', '--gold': '#64ffda', '--gold-light': '#a8ffff', '--soft-violet': '#5a7dbf', '--crimson': '#ff6b9d', '--jade': '#4ecdc4', '--text-primary': '#d4f1f9', '--text-secondary': '#7fb3d5', '--holoscreen-bg': 'rgba(10, 37, 64, 0.85)', '--highlight-glass': 'rgba(10, 60, 100, 0.6)', '--border-glass': 'rgba(100, 255, 218, 0.15)', '--glow-cyan': '#64ffda', '--glow-magenta': '#ff6b9d', '--shadow-color': 'rgba(0, 10, 20, 0.8)' } },
          sunset: { bodyBg: '#2c1810', colors: { '--space-black': '#2c1810', '--deep-purple': '#2c1e3e', '--gold': '#ff9f43', '--gold-light': '#ffc857', '--soft-violet': '#d94369', '--crimson': '#ff6348', '--jade': '#ffa500', '--text-primary': '#ffe8cc', '--text-secondary': '#d4a574', '--holoscreen-bg': 'rgba(44, 30, 62, 0.85)', '--highlight-glass': 'rgba(90, 40, 60, 0.6)', '--border-glass': 'rgba(255, 159, 67, 0.15)', '--glow-cyan': '#ffb347', '--glow-magenta': '#ff6b9d', '--shadow-color': 'rgba(0, 0, 0, 0.9)' } },
          forest: { bodyBg: '#0d1f16', colors: { '--space-black': '#0d1f16', '--deep-purple': '#1a3a2a', '--gold': '#2ecc71', '--gold-light': '#58d68d', '--soft-violet': '#27ae60', '--crimson': '#e74c3c', '--jade': '#16a085', '--text-primary': '#b8e6d5', '--text-secondary': '#7fb3a0', '--holoscreen-bg': 'rgba(26, 58, 42, 0.85)', '--highlight-glass': 'rgba(22, 80, 60, 0.6)', '--border-glass': 'rgba(46, 204, 113, 0.15)', '--glow-cyan': '#58d68d', '--glow-magenta': '#e74c3c', '--shadow-color': 'rgba(0, 0, 0, 0.85)' } },
          midnight: { bodyBg: '#0f0f1e', colors: { '--space-black': '#0f0f1e', '--deep-purple': '#1a1a2e', '--gold': '#e0e0e0', '--gold-light': '#ffffff', '--soft-violet': '#6b5b95', '--crimson': '#c91f16', '--jade': '#88c540', '--text-primary': '#f0f0f0', '--text-secondary': '#b0b0b0', '--holoscreen-bg': 'rgba(26, 26, 46, 0.85)', '--highlight-glass': 'rgba(30, 30, 60, 0.6)', '--border-glass': 'rgba(200, 200, 200, 0.1)', '--glow-cyan': '#e0e0e0', '--glow-magenta': '#ff6b9d', '--shadow-color': 'rgba(0, 0, 0, 0.95)' } },
          coral: { bodyBg: '#2d1b24', colors: { '--space-black': '#2d1b24', '--deep-purple': '#2d1b3d', '--gold': '#ff7b54', '--gold-light': '#ffa270', '--soft-violet': '#ff6b9d', '--crimson': '#c0392b', '--jade': '#26c281', '--text-primary': '#ffd9c9', '--text-secondary': '#d4a5a0', '--holoscreen-bg': 'rgba(45, 27, 45, 0.85)', '--highlight-glass': 'rgba(70, 30, 50, 0.6)', '--border-glass': 'rgba(255, 123, 84, 0.15)', '--glow-cyan': '#ffa270', '--glow-magenta': '#ff6b9d', '--shadow-color': 'rgba(0, 0, 0, 0.9)' } },
          royal: { bodyBg: '#21182F', colors: { '--space-black': '#21182F', '--deep-purple': '#402A50', '--gold': '#FFD700', '--gold-light': '#FFF0B3', '--soft-violet': '#A978D0', '--crimson': '#e74c3c', '--jade': '#50C878', '--text-primary': '#EADCF8', '--text-secondary': '#A090B0', '--holoscreen-bg': 'rgba(33, 24, 47, 0.85)', '--highlight-glass': 'rgba(64, 42, 80, 0.6)', '--border-glass': 'rgba(255, 215, 0, 0.15)', '--glow-cyan': '#FFD700', '--glow-magenta': '#A978D0', '--shadow-color': 'rgba(0, 0, 0, 0.85)' } },
          ocean: { bodyBg: '#001a33', colors: { '--space-black': '#001a33', '--deep-purple': '#003d66', '--gold': '#00d9ff', '--gold-light': '#66f2ff', '--soft-violet': '#0099cc', '--crimson': '#ff3366', '--jade': '#00cc99', '--text-primary': '#ccf2ff', '--text-secondary': '#66b3cc', '--holoscreen-bg': 'rgba(0, 61, 102, 0.85)', '--highlight-glass': 'rgba(0, 100, 150, 0.6)', '--border-glass': 'rgba(0, 217, 255, 0.15)', '--glow-cyan': '#00d9ff', '--glow-magenta': '#ff3366', '--shadow-color': 'rgba(0, 0, 0, 0.9)' } }
        };

        try {
          const savedThemeName = localStorage.getItem('selectedTheme') || 'mystical'; // Default theme
          const theme = THEMES[savedThemeName] || THEMES.mystical;
          const root = document.documentElement;

          // Set the background color directly on the body and the background container to prevent any flash.
          // We use a <style> tag because the body/div elements don't exist yet.
          const style = document.createElement('style');
          style.textContent = `
            body { background-color: ${theme.bodyBg}; }
            .background-container { background: ${theme.bodyBg}; } /* Set a solid color first */
          `;
          document.head.appendChild(style);

          // Set all the CSS variables for the rest of the page to use.
          if (theme.colors) {
            for (const [key, value] of Object.entries(theme.colors)) {
              root.style.setProperty(key, value);
            }
          }
        } catch (e) {
          console.error('Error applying initial theme:', e);
        }
      })();
    </script>

    <!-- Theme variables are now applied by control.js and initThemeSystem() -->

    <link rel="stylesheet" href="chinese_aesthetics.css">
</head>
<body>
    <div id="landing-gate">
        <div class="background-container">
            <div class="stars-bg"></div>
            <div class="chinese-pattern"></div>
            <canvas id="web-canvas-landing"></canvas>
            <canvas id="landing-particles-canvas"></canvas>
            <canvas id="spiral-canvas-landing" aria-hidden="true"></canvas>
        </div>
        <div class="gate-container">
            <div class="gate-content">
                <h1 class="main-title">NINI & ÂçìÈõÖ</h1>
                <h2 class="subtitle">THE CELESTIAL SANCTUARY</h2>
                <p class="description">Two souls from different corners of the world, brought together in Japan, finding love in the most unexpected way. A whisper of fate in the quiet alleys of Kyoto, a chance encounter under the Sakura trees, blooming into a love that transcends borders and time.</p>
                <p class="countries">Uganda <a href="#observatory-direct" id="heart-portal" class="heart-icon" style="text-decoration: none;">‚ù§</a> China</p>
                <p class="prophecy">IN A UNIVERSE OF INFINITE POSSIBILITIES, OUR SOULS FOUND EACH OTHER. THAT'S NOT COINCIDENCE‚ÄîIT'S DESTINY.</p>
                <p class="prompt">Click anywhere to enter the sanctuary...</p>
            </div>
        </div>
    </div>

    <main id="celestial-sanctuary" style="display: none;">
        <div class="background-container">
            <div class="stars-bg"></div>
            <div class="chinese-pattern"></div>
            <canvas id="web-canvas-main"></canvas>
            <canvas id="particles-canvas"></canvas>
            <canvas id="spiral-canvas-main" aria-hidden="true"></canvas>
        </div>
        
        <div id="book-password-gate" class="modal">
            <div class="modal-content" style="max-width: 500px; text-align: center;">
                <div class="tome-lock-icon"></div>
                <h2 class="tome-title">Protected Memory Vault</h2>
                <p class="tome-subtitle">This sacred tome requires our secret key to unlock.</p>
                <label class="speak-words-label">Speak the Words</label>
                <input type="password" id="book-password-input" class="text-input tome-input" placeholder="Enter Secret Key">
                <button class="btn primary tome-unlock-btn" id="unlock-book-btn">
                    <span class="btn-icon">üîë</span>Unlock Tome
                </button>
                <p class="hint-text">Hint: The four words that define our love, all lowercase, no spaces.</p>
            </div>
        </div>
        
        <div id="solar-system-container">
            <div id="music-player-sun">
                <div class="sun-surface">
                    <img id="sun-album-art" src="photos/photo1.jpg" alt="Album Art">
                </div>
                <div id="music-player-panel">
                    <div id="player-view-now-playing" class="player-view active">
                        <img id="panel-album-art" src="photos/photo1.jpg" alt="Album Art in player">
                        <div id="song-info">
                            <div id="song-title">Select a Song</div>
                            <div id="song-artist">Our Soundtrack</div>
                        </div>
                        <div id="progress-bar-container"><div id="progress-bar"></div></div>
                        <div id="time-container">
                            <span id="current-time">0:00</span>
                            <span id="total-duration">0:00</span>
                        </div>
                        <div id="music-controls">
                            <button class="control-btn" id="shuffle-btn" title="Shuffle">üîÄ</button>
                            <button class="control-btn" id="prev-btn" title="Previous">‚Æú</button>
                            <button class="control-btn" id="play-pause-btn" title="Play/Pause" style="font-size: 2rem;">‚ñ∂Ô∏è</button>
                            <button class="control-btn" id="next-btn" title="Next">‚Æû</button>
                        </div>
                        <div id="volume-container">
                            <span>üîà</span>
                            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
                            <span>üîä</span>
                        </div>
                    </div>
                    <div id="player-view-playlist" class="player-view">
                        <h4 style="font-size: 1.1rem; margin-bottom: 0.5rem; text-align: center; font-family: var(--font-display);">Playlist</h4>
                        <div>
                            <button class="btn" id="upload-music-btn">Upload Song</button>
                            <input type="file" id="music-upload-input" hidden accept="audio/*">
                        </div>
                        <div id="playlist"></div>
                    </div>
                    <div class="player-tabs">
                        <button class="player-tab-btn active" data-view="now-playing" title="Now Playing">üéµ</button>
                        <button class="player-tab-btn" data-view="playlist" title="Playlist">üìú</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="planet-name-display" class="planet-name-display"></div>

        <div class="main-content"></div>
        
    </main>

    <!-- MOOD SYNC BAR - Always visible -->
    <div id="mood-sync-bar">
        <div id="mood-sync-content">
            <div class="mood-selector left-selector">
                <span class="mood-label">Nic's Mood</span>
                <div class="mood-picker-dropdown">
                    <button class="current-mood-btn" id="nic-current-mood" data-person="nic">
                        <span class="mood-emoji">üòä</span>
                        <span class="mood-name">Happy</span>
                    </button>
                    <div class="mood-options" id="nic-mood-options">
                        <!-- Mood options will be populated by JS -->
                    </div>
                </div>
            </div>
            
            <div class="mood-center">
                <div class="combined-mood-display">
                    <span class="combined-icon">üíï</span>
                    <span class="combined-text">In Sync</span>
                </div>
                <canvas id="mood-particles"></canvas>
                <!-- Mood Sync toggle (off by default) -->
                <div class="mood-toggle-container" style="position: absolute; bottom: -6px; right: 8px; font-size: 0.9rem; color: var(--gold-light); display:flex; align-items:center; gap:8px;">
                    <label for="mood-sync-toggle" style="cursor:pointer;">Mood Sync</label>
                    <input type="checkbox" id="mood-sync-toggle" aria-label="Enable Mood Sync">
                </div>
            </div>
            
            <div class="mood-selector right-selector">
                <span class="mood-label">Zoya's Mood</span>
                <div class="mood-picker-dropdown">
                    <button class="current-mood-btn" id="zoya-current-mood" data-person="zoya">
                        <span class="mood-emoji">üíï</span>
                        <span class="mood-name">Loving</span>
                    </button>
                    <div class="mood-options" id="zoya-mood-options">
                        <!-- Mood options will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
        <button id="mood-sync-visibility-toggle" title="Toggle Mood Bar"><span>‚ñ≤</span></button>
    </div>

    <!-- Mood Recommendation Popup -->
    <div id="mood-recommendation-popup" class="mood-popup">
        <div class="mood-popup-content">
            <button class="mood-popup-close">&times;</button>
            <div class="mood-popup-icon">üí°</div>
            <h3 class="mood-popup-title">Cosmic Suggestion</h3>
            <p class="mood-popup-message"></p>
            <button class="btn primary mood-popup-action">Take Me There</button>
        </div>
    </div>

    <div id="main-menu-container">
        <button id="main-menu-button" title="Open Menu">
            <img id="menu-icon-img" src="photos/favicon1.png" alt="Open Menu">
        </button>
        <div id="main-menu-dropdown">
            <a href="#home" onclick="closeMenu()">Solar System</a>
            <a href="#games" onclick="closeMenu()">Orion's Challenges</a>
            <a href="#timeline" onclick="closeMenu()">Our Chronicle</a>
            <a href="#book" onclick="closeMenu()">The Stardust Tome</a>
            <a href="#gallery" onclick="closeMenu()">Gallery of Ages</a>
            <a href="#guide" onclick="closeMenu(); returnToGuideHub();">Constellation Guide</a>
            <a href="#universes" onclick="closeMenu()">Alternate Chronicles</a>
            <a href="#voicegarden" onclick="closeMenu()">Voice Garden</a>
            <a href="#sanctuary" onclick="closeMenu()">Inner Sanctum</a>
        </div>
    </div>
    
    <div id="chapter-meta-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="panel-header" style="margin-bottom: 1.5rem;">A New Chapter</h3>
            <div class="form-group">
                <label for="new-chapter-title">Chapter Title</label>
                <input type="text" id="new-chapter-title" class="text-input">
            </div>
            <div class="form-group">
                <label for="new-chapter-author">Author</label>
                <input type="text" id="new-chapter-author" class="text-input" value="Nini & Zoya">
            </div>
            <div class="form-group">
                <label for="new-chapter-date">Date</label>
                <input type="date" id="new-chapter-date" class="text-input">
            </div>
            <div class="modal-actions">
                <button class="btn" id="cancel-meta-btn">Cancel</button>
                <button class="btn primary" id="continue-meta-btn">Continue</button>
            </div>
        </div>
    </div>
    
    <div id="editor-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <h3 id="editor-title" class="panel-header" style="margin-bottom: 1.5rem;">Edit Entry</h3>
            <div id="quill-editor-container">
                <div id="quill-editor"></div>
            </div>
            <div class="modal-actions">
                <button class="btn" id="cancel-edit-btn">Cancel</button>
                <button class="btn primary" id="save-edit-btn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="lightbox" class="modal">
        <div class="lightbox-content">
            <img class="lightbox-image" id="lightbox-image" src="" alt="Gallery Image">
            <div class="lightbox-info">
                <h3 id="lightbox-caption"></h3>
            </div>
        </div>
        <button class="lightbox-nav lightbox-close">√ó</button>
        <button class="lightbox-nav lightbox-prev">‚Äπ</button>
        <button class="lightbox-nav lightbox-next">‚Ä∫</button>
    </div>
    
    <div id="game-play-modal" class="reward-modal">
        <div class="game-play-modal-content">
            <span class="close-button" onclick="closeGame()">&times;</span>
            <div id="game-play-area"></div>
        </div>
    </div>

    <div id="reward-modal" class="reward-modal">
        <div class="reward-modal-content">
            <span class="close-button" onclick="closeRewardModal()">&times;</span>
            <h2 id="reward-title">A Reward from the Cosmos!</h2>
            <div id="reward-display"></div>
        </div>
    </div>

    <button id="scroll-to-top" title="Go to top">‚Üë</button>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="book_content.js"></script>
    <script src="control.js"></script>
    <script>
        function closeMenu() {
            const menuDropdown = document.getElementById('main-menu-dropdown');
            const menuIcon = document.getElementById('menu-icon-img');
            if (menuDropdown) menuDropdown.classList.remove('visible');
            if (menuIcon) menuIcon.src = 'photos/favicon1.png';

            // Reset theme selector state when menu closes
            const themeContainer = document.querySelector('.theme-colors-grid');
            const themeToggleBtn = document.querySelector('.theme-toggle-btn');
            const menuLinks = menuDropdown ? menuDropdown.querySelectorAll('a') : [];
            const separator = menuDropdown ? menuDropdown.querySelector('hr') : null;

            if (themeContainer) themeContainer.style.display = 'none';
            if (themeToggleBtn) themeToggleBtn.classList.remove('active');
            menuLinks.forEach(link => link.style.display = 'block');
            if (separator) separator.style.display = 'block';
        }
    </script>
    <script src="chinese_enhancements.js"></script>
</body>
</html>